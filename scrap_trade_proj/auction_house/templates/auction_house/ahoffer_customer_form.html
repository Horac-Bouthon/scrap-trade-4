{% extends "project_main/base.html" %}
{% load crispy_forms_tags %}
{% load i18n %}


{% block content %}
  
  {% include 'project_main/__content-header.html' %}
  
  
  <section class="content-pad">

    <div class="mb-3">
      
      {% for next in object.actual_state.next_states.all %}
        {% if next.manual_set == True %}  {# = `next` is settable manually #}

          {# Note: All button hrefs are derived from the state pk #}
          {% url 'ah-offer-change-state' object.owner.pk object.pk next.pk as btn_href %}
          
          {# Proceed to next state #}
          {% if next.is_alert_button == False %}
            <a href="{{ btn_href }}"

               {% if next.security_level == 0 %}
               class="btn btn-primary"
               {% elif next.security_level == 1 and "customers.is_customer_admin" in perms %}
               class="btn btn-primary"
               {% elif next.security_level >= 2 and "customers.is_poweruser" in perms %}
               class="btn btn-poweruser"
               {% endif %}
            >
              {{ next.get_actual_state_button }}
            </a>  
          {% endif %}
          
          {# Dangerous actions #}
          {% if next.is_alert_button == True %}
            <a href="{{ btn_href }}"
               
               {% if next.security_level == 0 %}  
               class="btn btn-danger"
               {% elif next.security_level == 1 and "customers.is_customer_admin" in perms %}
               class="btn btn-danger"
               {% elif next.security_level >= 2 and "customers.is_poweruser" in perms %}
               class="btn btn-outline-danger btn-poweruser"
               {% endif %}
            >
              {{ next.get_actual_state_button }}
            </a>
          {% endif %}
          
        {% endif %}
      {% endfor %}

      <div class="tip">
        {% trans "Tip: Setting a state discards any unsaved changes made on this page." %}
        {% trans "Please make sure to save any changes before changing offer's state." %}
      </div>
    </div>
    

    {# Actual form for editing #}
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      
      <fieldset>
        
        {{ form|crispy }}
        
        <div>
          {% include 'project_main/__btn-submit-save.html' %}
          
          <a class="btn btn-outline-secondary"
             href="{% url 'ah-offer-detail' object.pk %}">
            {% trans "Cancel" %}
          </a>
        </div>
        
      </fieldset>
    </form>
    
  </section>
{% endblock content %}
